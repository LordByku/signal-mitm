# Sealed Sender

- Sender-anonymity by including their identity as part of te encrypted body of the message.
- Receiver's identity must always be present for delivery purposes.

- 2 variants:
    - SS v1 - initial release of the system
    - SS v2 -- "improved version" (current doc)

terminology:

uak - unidentified access key (todo: determine actual usage and sealed_sender v2 decryption)


- after initial ratchet (A & B), all future messages are sent using Sealed Sender
    - also, Sealed Sender can be allowed for unknown recipients, if desired (`allowSealedSenderFromAnyone`)
- Sealed Sender also works with groups
   - open question #1: How does that work
 

Sender Certificates - 
 retrieve from `/v1/certificate/delivery` (by default both aci and pni, there is an optional `?includeE164=false` to only retrieve the certificate only for your own ACI ( certs are generated by the server based on the public identity\_key)

- certificate is signed with a key pinned which can then be validated against the trust-root hardcoded in the clients
c.f  "UNIDENTIFIED\_SENDER\_TRUST\_ROOT"

DeliveryToken -
clients derive a 96-bit delivery token from their profile key and register it with the service
used for reporting

to send a message with sealed sender, you must:
1. Encrypt the message using Signal Protocol as usual.
2. Include a sender certificate in the envelope.
3. Encrypt the envelope to the recipient.
4. Without authenticating, hand the encrypted envelope to the service along with the recipient’s delivery token.

# Session establishment

## Assumptions: 
__Fresh users, contact Discovery (via phone number)__

## Process
### Initial Request by Alice

- Alice (the initiator) requests Bob's PNI pre-key bundle, which includes sets of keys associated with Bob's PNI identity.
- Alice initiates a session between her ACI store and Bob's PNI bundle.

### Session Initiation by Alice

- This creates a key agreement between Alice's ACI store and Bob's PNI bundle.
- Alice encrypts with the derived shared key coming from the aforementioned agreement. 
- Alice includes her ACI UUID as the source and her ACI Identity Key in the envelope.
- The destination is set to PNI:{Bob_PNI_uuid} since Alice has no prior information about Bob's ACI.

### Decryption by Bob

- Bob derives the shared secret from the key agreement using his PNI private keys from the bundle and decrypts the ciphertext.
- Bob receives an Envelope containing Alice's ACI uuid as source and his own PNI uuid as destination.

### Request for Alice's ACI Bundle by Bob

- If Bob proceeds to accept to chat with Alice, starts the process of switching from PNI to full ACI.
- Bob's accept action triggers:
  -    Bob requests Alice's ACI pre-key bundle from the server.
  -    Bob starts a new session by performing a key agreement using his own ACI store, thereby switching to the ACI context (similar to the process used before usernames).
- Bob creates a DataMessage with Flag=4 (`PROFILE_KEY_UPDATE`)

### UnidentifiedSenderMessage from Bob

-    Bob encrypts the message with the keys derived by the freshly generated session and sends an UnidentifiedSenderMessage (protobuf) including an ephemeral public key required by Alice to perform her side of the protocol and ciphertext.
-    Bob includes his ACI UUID as the source and destination as Alice's ACI UUID.
-    Bob also includes his PNI uuid and a PNISignature in the encrypted content. This is to ensure that Alice can verify the sender's identity and map the two identities, ACI and PNI. PNISignature is generated by signing ACI public key with PNI private identity.

### Switching to ACI Context by Alice

- Upon receiving the message from Bob, Alice derives the shared secret key from the session implicitly initiated by Bob
  - She performs a key agreement using the received ephemeral key and the identity key fetched from the profile info endpoints.
  - Alice decrypts the ciphertext using the derived key and verifies the sender's identity using the PNISignature. 
  - If the signature is valid, Alice "transfers" her session to the ACI store.

### Result

-    Alice and Bob are now in a full ACI context.

```
┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                                                          │
│                                                                                                                          │
│                                                                                                                          │
│                                                                                                                          │
│          Alice                                         Server                                           Bob              │
│                                                                                                                          │
│                                                                                                                          │
│                                                                                                                          │
│                         /v1/profile/PNI:Bob                                                                              │
│                                                                                                                          │
│            ───────────────────────────────────────────────►                                                              │
│                                                                                                                          │
│                                                                                                                          │
│                                                                                                                          │
│                         IdentityKey_PNI_Bob                                                                              │
│                                                                                                                          │
│            ◄───────────────────────────────────────────────                                                              │
│                                                                                                                          │
│                                                                                                                          │
│                                                                                                                          │
│                         /v2/keys?PNI:{PNI_Bob}                                                                           │
│                                                                                                                          │
│            ───────────────────────────────────────────────►                                                              │
│                                                                                                                          │
│                                                                                                                          │
│                                                                                                                          │
│                         PreKeyBundle_PNI_Bob                                                                             │
│                                                                                                                          │
│            ◄───────────────────────────────────────────────                                                              │
│                                                                                                                          │
│                                                                                                                          │
│                                                                                                                          │
│                                                                                                                          │
│          ┌─────────────────────────────────────────────────┐                                                             │
│          │ Alice computes a key agreement with PreKeyBundle│                                                             │
│          │ _PNI_Bob and with her own ACI store.            │                                                             │
│          │                                                 │                                                             │
│          │ This means a session between initiator ACI keys │                                                             │
│          │ and PNI PreKeyBundle of Bob.                    │                                                             │
│          └─────────────────────────────────────────────────┘                                                             │
│                                                                                                                          │
│                                                                                                                          │
│                                                                                        src: ACI                          │
│                         PKSM-->IK_ACI_Alice, ctxt                          Envelope-->                                   │
│                                                                                        dst: PNI                          │
│            ───────────────────────────────────────────────► ───────────────────────────────────────────────►             │
│                                                                                                                          │
│                                                                                                                          │
│                                                                                                                          │
│                                                                            /v2/keys?{ACI_Alice}                          │
│                                                                                                                          │
│                                                             ◄───────────────────────────────────────────────             │
│                                                                                                                          │
│                                                                                                                          │
│                                                                                                                          │
│                                                                            PreKeyBundle_ACI_Alice                        │
│                                                                                                                          │
│                                                             ───────────────────────────────────────────────►             │
│                                                                                                                          │
│                                                                                                                          │
│                                                                                                                          │
│                                                                 UnidentifiedSenderMessage(Sealed Sender)                 │
│                                                                                                                          │
│                                                            ◄────────────────────────────────────────────────             │
│                                                                                                                          │
│                                                                                  src: ACI                                │
│                                                                                                                          │
│                                                                                  dst: PNI                                │
│                                                                                                                          │
│                                                                                                                          │
│                                                                                                                          │
│                                                                                                                          │
│                                                                                                                          │
└──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```
