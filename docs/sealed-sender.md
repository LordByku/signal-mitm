# Sealed Sender

- Sender-anonymity by including their identity as part of the encrypted body of the message.
- Receiver's identity must always be present such that the server can correctly route the message into the receiver's mailbox.

- 2 variants:
    - SS v1 - initial release of the system
    - SS v2 -- "improved version" (current doc)

terminology:

`uak` - unidentified access key (todo: determine actual usage and sealed_sender v2 decryption)


- **Typical case**: After Alice and Bob complete their handshake and set up shared ratchet state, they exchange one message each. After that all future messages are sent using Sealed Sender.
    - also, Sealed Sender can be allowed for unknown recipients, if desired (`allowSealedSenderFromAnyone`) => This is disabled by default to allow the server to do some rate limiting (spam prevention).
- Sealed Sender also works with groups
   - open question #1: How does that work (details)
 

**Sender Certificates**: "Signed return address" => In order to prevent abuse, the server will issue signed return adresses. Only these are valid inside encyrypted Sealed Sender envelopes. Thus, there is a second trust root hardcoded in the application such that the receiver can check the authenticity of the sender.

  - [ ] TODO: Make a diagram defining how the sender certificate looks like (what's in it, what's signed etc..)


Sender Certificates are retrieved from `/v1/certificate/delivery` (by default both ACI and PNI are signed, there is an optional `?includeE164=false` to only retrieve the certificate only for your ACI (certs are generated by the server based on the public identity\_key)

- certificate is signed with a pinned key which is validated against the trust-root hardcoded in the clients
c.f  "UNIDENTIFIED\_SENDER\_TRUST\_ROOT"

DeliveryToken -
clients derive a 96-bit delivery token from their profile key and register it with the service
used for reporting

to send a message with sealed sender, you must:
1. Encrypt the message using Signal Protocol as usual.
2. Include a sender certificate in the envelope.
3. Encrypt the envelope to the recipient (handled by the signal library, and done with the `uai`-key of the receiver).
4. Without authenticating, hand the encrypted envelope to the service along with the recipient’s delivery token.

# Session establishment

## Assumptions: 
__Fresh users, contact Discovery (via phone number)__

## Process
### Initial Request by Alice

- Alice (the initiator) requests Bob's PNI pre-key bundle, which includes sets of keys associated with Bob's PNI from the server.
- Alice initiates a session between her ACI store and Bob's PNI bundle (the ACI store and the PNI bundle are both inputs to libsignal which will give you a session in return).

### Session Initiation by Alice

- This begins a PQXDH key agreement between Alice's ACI store and Bob's PNI bundle.
- Alice encrypts the payload with the first `message key` of her sending ratched (Bob's receiving ratched) derived in the aforementioned agreement. 
- Alice includes her ACI UUID as the source and her ACI Identity Key in the envelope (plain text).
- The destination is set to `PNI:{Bob_PNI_uuid}` since Alice has no prior information about Bob's ACI.

### Decryption by Bob

- Bob receives an envelope containing Alice's ACI uuid as source and his own PNI uuid as destination.
- Bob derives the corresponding `message key` from the same handshake described before and decrypts the message.

### Request for Alice's ACI Bundle by Bob

- If Bob proceeds to accept to chat with Alice, he starts the process of switching from PNI context to an ACI context.
- Bob's accept action (UI) triggers:
  -    Bob requests Alice's ACI pre-key bundle from the server.
  -    Bob starts a new session by performing a key agreement using his own ACI store, thereby switching to the ACI context.
- Bob creates a DataMessage with Flag=4 (`PROFILE_KEY_UPDATE`) (there will be no payload).

### Bob tells Alice to switch context

-    Bob encrypts the message with the keys derived from the freshly generated session and sends an `UnidentifiedSenderMessage` (sealed sender) (protobuf) including an ephemeral public key required by Alice to perform her side of the protocol and ciphertext.
-    Bob includes his ACI UUID as the source and Alice's ACI UUID as the destination.
-    Bob also includes his PNI UUID and a PNISignature in the encrypted content. This is to ensure that Alice can verify the sender's identity and connect their two cryptographic identities (ACI and PNI). The PNISignature is generated by signing the ACI public key with the PNI private identity key.

### Switching to ACI Context by Alice

- Upon receiving the message from Bob, Alice derives the shared secret key from the session implicitly initiated by Bob
  - She performs a key agreement using the received ephemeral key and the identity key fetched from the profile info endpoints.
  - Alice decrypts the ciphertext using the derived key and verifies the sender's identity by verifying the PNISignature. 
  - If the signature is valid, Alice "transfers" her session to the ACI store.

### Result

-    Alice and Bob now share a double ratchet session set up with their ACIs.

```
┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                                                          │
│                                                                                                                          │
│                                                                                                                          │
│                                                                                                                          │
│          Alice                                         Server                                           Bob              │
│                                                                                                                          │
│                                                                                                                          │
│                                                                                                                          │
│                         /v1/profile/PNI:Bob                                                                              │
│                                                                                                                          │
│            ───────────────────────────────────────────────►                                                              │
│                                                                                                                          │
│                                                                                                                          │
│                                                                                                                          │
│                         IdentityKey_PNI_Bob                                                                              │
│                                                                                                                          │
│            ◄───────────────────────────────────────────────                                                              │
│                                                                                                                          │
│                                                                                                                          │
│                                                                                                                          │
│                         /v2/keys?PNI:{PNI_Bob}                                                                           │
│                                                                                                                          │
│            ───────────────────────────────────────────────►                                                              │
│                                                                                                                          │
│                                                                                                                          │
│                                                                                                                          │
│                         PreKeyBundle_PNI_Bob                                                                             │
│                                                                                                                          │
│            ◄───────────────────────────────────────────────                                                              │
│                                                                                                                          │
│                                                                                                                          │
│                                                                                                                          │
│                                                                                                                          │
│          ┌─────────────────────────────────────────────────┐                                                             │
│          │ Alice computes a key agreement with PreKeyBundle│                                                             │
│          │ _PNI_Bob and with her own ACI store.            │                                                             │
│          │                                                 │                                                             │
│          │ This means a session between initiator ACI keys │                                                             │
│          │ and PNI PreKeyBundle of Bob.                    │                                                             │
│          └─────────────────────────────────────────────────┘                                                             │
│                                                                                                                          │
│                                                                                                                          │
│                                                                                        src: ACI                          │
│                         PKSM-->IK_ACI_Alice, ctxt                          Envelope-->                                   │
│                                                                                        dst: PNI                          │
│            ───────────────────────────────────────────────► ───────────────────────────────────────────────►             │
│                                                                                                                          │
│                                                                                                                          │
│                                                                                                                          │
│                                                                            /v2/keys?{ACI_Alice}                          │
│                                                                                                                          │
│                                                             ◄───────────────────────────────────────────────             │
│                                                                                                                          │
│                                                                                                                          │
│                                                                                                                          │
│                                                                            PreKeyBundle_ACI_Alice                        │
│                                                                                                                          │
│                                                             ───────────────────────────────────────────────►             │
│                                                                                                                          │
│                                                                                                                          │
│                                                                                                                          │
│                                                                 UnidentifiedSenderMessage(Sealed Sender)                 │
│                                                                                                                          │
│                                                            ◄────────────────────────────────────────────────             │
│                                                                                                                          │
│                                                                                  src: ACI                                │
│                                                                                                                          │
│                                                                                  dst: PNI                                │
│                                                                                                                          │
│                                                                                                                          │
│                                                                                                                          │
│                                                                                                                          │
│                                                                                                                          │
└──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```
